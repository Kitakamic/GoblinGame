name: bundle

on:
  push:
    branches:
      - master
      - main
      - newConstruction
    paths-ignore:
      - dist/**
  workflow_dispatch:

permissions:
  actions: read
  contents: write

concurrency:
  group: ${{ github.workflow }}

jobs:
  bundle:
    if: github.repository != 'StageDog/tavern_helper_template'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: JesseTG/rm@v1.0.3
        with:
          path: dist

      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
      - name: Setup pnpm
        uses: pnpm/action-setup@v4.1.0
        with:
          version: 10

      - run: pnpm install && pnpm format && pnpm build
      - name: Commit changes
        uses: EndBug/add-and-commit@v9.1.3
        with:
          default_author: github_actions
          message: '[bot] bundle'

      # è‡ªåŠ¨æ‰“ç‰ˆæœ¬ tag, ä»è€Œè®© jsdelivr åŸºäºç‰ˆæœ¬å·åœ¨ 12h å†…æ›´æ–°ç¼“å­˜è€Œä¸æ˜¯ç”¨éç‰ˆæœ¬å·çš„ 7d ç¼“å­˜
      - id: autotag
        uses: phish108/autotag-action@v1.1.64
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          with-v: true
      - if: ${{ steps.autotag.outputs.tag != '0.0.0' }}
        run: git push --delete origin ${{ steps.autotag.outputs.tag }}

      # è¯»å–ç‰ˆæœ¬å·
      - name: Read version
        id: read_version
        run: |
          VERSION=$(grep -oP "export const FRONTEND_VERSION = '([^']+)'" src/å“¥å¸ƒæ—å·¢ç©´-ç®€ç‰ˆ/version.ts | grep -oP "'([^']+)'" | tr -d "'")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "è¯»å–åˆ°ç‰ˆæœ¬å·: $VERSION"

      # è¯»å–æ˜¯å¦æ¨é€ index.html è®¾ç½®
      - name: Read push index.html setting
        id: read_push_index
        run: |
          PUSH_INDEX=$(grep -oP "export const FRONTEND_PUSH_INDEX_HTML: boolean = (true|false)" src/å“¥å¸ƒæ—å·¢ç©´-ç®€ç‰ˆ/version.ts | grep -oP "(true|false)")
          if [ -z "$PUSH_INDEX" ]; then
            PUSH_INDEX="false"
          fi
          echo "push_index=$PUSH_INDEX" >> $GITHUB_OUTPUT
          echo "è¯»å–åˆ°æ¨é€ index.html è®¾ç½®: $PUSH_INDEX"

      # ä¸Šä¼ å¸¦ç‰ˆæœ¬å·çš„ index.html åˆ° Cloudflare R2
      - name: Upload versioned index.html to Cloudflare R2
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
          R2_BUCKET: gobgame-pic
          R2_ACCOUNT_ID: ${{ secrets.R2_ACCOUNT_ID }}
          VERSION: ${{ steps.read_version.outputs.version }}
          PUSH_INDEX: ${{ steps.read_push_index.outputs.push_index }}
        run: |
          # æ£€æŸ¥å¸¦ç‰ˆæœ¬å·çš„æ–‡ä»¶æ˜¯å¦å­˜åœ¨
          VERSIONED_FILE="dist/å“¥å¸ƒæ—å·¢ç©´-ç®€ç‰ˆ/index-v${VERSION}.html"
          if [ ! -f "$VERSIONED_FILE" ]; then
            echo "é”™è¯¯: ç‰ˆæœ¬åŒ–æ–‡ä»¶ä¸å­˜åœ¨: $VERSIONED_FILE"
            echo "æ„å»ºè¾“å‡ºç›®å½•å†…å®¹:"
            ls -la dist/ || echo "dist ç›®å½•ä¸å­˜åœ¨"
            ls -la dist/å“¥å¸ƒæ—å·¢ç©´-ç®€ç‰ˆ/ || echo "dist/å“¥å¸ƒæ—å·¢ç©´-ç®€ç‰ˆ/ ç›®å½•ä¸å­˜åœ¨"
            exit 1
          fi

          # ä¸Šä¼ å¸¦ç‰ˆæœ¬å·çš„æ–‡ä»¶
          echo "ä¸Šä¼ ç‰ˆæœ¬åŒ–æ–‡ä»¶: index-v${VERSION}.html"
          aws s3 cp "$VERSIONED_FILE" "s3://${R2_BUCKET}/index-v${VERSION}.html" \
            --endpoint-url "https://${R2_ACCOUNT_ID}.r2.cloudflarestorage.com" \
            --content-type "text/html" \
            --cache-control "no-cache, must-revalidate"

          echo "âœ“ å·²ä¸Šä¼ ç‰ˆæœ¬ ${VERSION} åˆ° R2 å­˜å‚¨"

          # å¦‚æœè®¾ç½®äº†æ¨é€ index.htmlï¼ŒåŒæ—¶ä¸Šä¼  index.html
          if [ "$PUSH_INDEX" = "true" ]; then
            INDEX_FILE="dist/å“¥å¸ƒæ—å·¢ç©´-ç®€ç‰ˆ/index.html"
            if [ -f "$INDEX_FILE" ]; then
              echo "ä¸Šä¼  index.htmlï¼ˆè¦†ç›–æœ€æ–°ç‰ˆæœ¬ï¼‰"
              aws s3 cp "$INDEX_FILE" "s3://${R2_BUCKET}/index.html" \
                --endpoint-url "https://${R2_ACCOUNT_ID}.r2.cloudflarestorage.com" \
                --content-type "text/html" \
                --cache-control "no-cache, must-revalidate"
              echo "âœ“ å·²ä¸Šä¼  index.html åˆ° R2 å­˜å‚¨"
            else
              echo "âš ï¸ è­¦å‘Š: index.html æ–‡ä»¶ä¸å­˜åœ¨ï¼Œè·³è¿‡ä¸Šä¼ "
            fi
          else
            echo "â„¹ï¸ æœªè®¾ç½®æ¨é€ index.htmlï¼Œè·³è¿‡"
          fi

      # ğŸ”¹ ç”Ÿæˆå¹¶ä¸Šä¼ ç‰ˆæœ¬åˆ—è¡¨æ–‡ä»¶
      - name: Update version list and upload to R2
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
          R2_BUCKET: gobgame-pic
          R2_ACCOUNT_ID: ${{ secrets.R2_ACCOUNT_ID }}
          VERSION: ${{ steps.read_version.outputs.version }}
        run: |
          # è¯»å–ç‰ˆæœ¬å·ã€æ—¥æœŸã€æè¿°å’Œç±»å‹
          VERSION_DATE=$(grep -oP "export const FRONTEND_UPDATE_DATE = '([^']+)'" src/å“¥å¸ƒæ—å·¢ç©´-ç®€ç‰ˆ/version.ts | grep -oP "'([^']+)'" | tr -d "'")
          VERSION_DESC=$(grep -oP "export const FRONTEND_DESCRIPTION = '([^']+)'" src/å“¥å¸ƒæ—å·¢ç©´-ç®€ç‰ˆ/version.ts | grep -oP "'([^']+)'" | tr -d "'")
          VERSION_TYPE=$(grep "export const FRONTEND_VERSION_TYPE" src/å“¥å¸ƒæ—å·¢ç©´-ç®€ç‰ˆ/version.ts | grep -oP "= '([^']+)'" | tr -d "=' " | xargs)

          # å¦‚æœæè¿°ä¸ºç©ºï¼Œä½¿ç”¨é»˜è®¤å€¼
          if [ -z "$VERSION_DESC" ]; then
            VERSION_DESC="æœ€æ–°ç‰ˆæœ¬"
          fi

          # å¦‚æœç±»å‹ä¸ºç©ºï¼Œé»˜è®¤ä¸ºç¨³å®šç‰ˆ
          if [ -z "$VERSION_TYPE" ]; then
            VERSION_TYPE="stable"
          fi

          # å¦‚æœç‰ˆæœ¬åˆ—è¡¨æ–‡ä»¶å·²å­˜åœ¨ï¼Œè¯»å–å¹¶æ›´æ–°ï¼›å¦åˆ™åˆ›å»ºæ–°çš„
          if aws s3 ls "s3://${R2_BUCKET}/versions.json" --endpoint-url "https://${R2_ACCOUNT_ID}.r2.cloudflarestorage.com" > /dev/null 2>&1; then
            echo "ç‰ˆæœ¬åˆ—è¡¨æ–‡ä»¶å·²å­˜åœ¨ï¼Œè¯»å–å¹¶æ›´æ–°..."
            aws s3 cp "s3://${R2_BUCKET}/versions.json" versions.json \
              --endpoint-url "https://${R2_ACCOUNT_ID}.r2.cloudflarestorage.com"
            
            # ä½¿ç”¨ Python æ›´æ–° JSONï¼ˆæ›´å¯é ï¼‰
            # å³ä½¿ç‰ˆæœ¬å·²å­˜åœ¨ï¼Œä¹Ÿæ›´æ–°å…¶ä¿¡æ¯ï¼ˆç±»å‹ã€æè¿°ã€æ—¥æœŸç­‰ï¼‰
            python3 << EOF
          import json

          with open('versions.json', 'r', encoding='utf-8') as f:
              data = json.load(f)

          new_version = {
              "version": "${VERSION}",
              "description": "${VERSION_DESC}",
              "date": "${VERSION_DATE}",
              "type": "${VERSION_TYPE}"
          }

          # ç§»é™¤å·²å­˜åœ¨çš„ç›¸åŒç‰ˆæœ¬ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
          data["versions"] = [v for v in data["versions"] if v["version"] != "${VERSION}"]

          # æ·»åŠ åˆ°åˆ—è¡¨å¼€å¤´ï¼ˆæœ€æ–°ç‰ˆæœ¬åœ¨å‰ï¼‰
          data["versions"].insert(0, new_version)

          # ä¿å­˜æ–‡ä»¶
          with open('versions.json', 'w', encoding='utf-8') as f:
              json.dump(data, f, indent=2, ensure_ascii=False)
          EOF
            echo "âœ“ å·²æ›´æ–°ç‰ˆæœ¬ ${VERSION} (ç±»å‹: ${VERSION_TYPE}) åˆ°ç‰ˆæœ¬åˆ—è¡¨"
          else
            echo "ç‰ˆæœ¬åˆ—è¡¨æ–‡ä»¶ä¸å­˜åœ¨ï¼Œåˆ›å»ºæ–°æ–‡ä»¶..."
            cat > versions.json << EOF
          {
            "versions": [
            {
              "version": "${VERSION}",
              "description": "${VERSION_DESC}",
              "date": "${VERSION_DATE}",
              "type": "${VERSION_TYPE}"
            }
            ]
          }
          EOF
          fi

          # ä¸Šä¼ ç‰ˆæœ¬åˆ—è¡¨æ–‡ä»¶
          echo "ä¸Šä¼ ç‰ˆæœ¬åˆ—è¡¨æ–‡ä»¶..."
          aws s3 cp versions.json "s3://${R2_BUCKET}/versions.json" \
            --endpoint-url "https://${R2_ACCOUNT_ID}.r2.cloudflarestorage.com" \
            --content-type "application/json" \
            --cache-control "public, max-age=300"

          echo "âœ“ ç‰ˆæœ¬åˆ—è¡¨å·²æ›´æ–°å¹¶ä¸Šä¼ åˆ° R2 å­˜å‚¨"

      # ğŸ”¹ æ¸…ç† Cloudflare Edge ç¼“å­˜
      - name: Purge Cloudflare Cache
        env:
          CF_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CF_ZONE_ID: ${{ secrets.CF_ZONE_ID }}
          VERSION: ${{ steps.read_version.outputs.version }}
          PUSH_INDEX: ${{ steps.read_push_index.outputs.push_index }}
        run: |
          # å‡†å¤‡è¦æ¸…ç†ç¼“å­˜çš„æ–‡ä»¶åˆ—è¡¨
          FILES_TO_PURGE='["https://kitakamis.online/index-v'${VERSION}'.html"'

          # å¦‚æœæ¨é€äº† index.htmlï¼Œä¹Ÿéœ€è¦æ¸…ç†å®ƒçš„ç¼“å­˜
          if [ "$PUSH_INDEX" = "true" ]; then
            FILES_TO_PURGE="${FILES_TO_PURGE},\"https://kitakamis.online/index.html\""
          fi

          FILES_TO_PURGE="${FILES_TO_PURGE}]"

          echo "æ¸…ç†ç¼“å­˜æ–‡ä»¶: ${FILES_TO_PURGE}"
          curl -X POST "https://api.cloudflare.com/client/v4/zones/${CF_ZONE_ID}/purge_cache" \
            -H "Authorization: Bearer ${CF_API_TOKEN}" \
            -H "Content-Type: application/json" \
            --data "{\"files\":${FILES_TO_PURGE}}"

          echo "âœ“ å·²æ¸…ç† Cloudflare Edge ç¼“å­˜"
