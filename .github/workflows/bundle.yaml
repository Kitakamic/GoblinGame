name: bundle

on:
  push:
    branches:
      - master
      - main
      - feature/version-management
    paths-ignore:
      - dist/**
  workflow_dispatch:

permissions:
  actions: read
  contents: write

concurrency:
  group: ${{ github.workflow }}

jobs:
  bundle:
    if: github.repository != 'StageDog/tavern_helper_template'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: JesseTG/rm@v1.0.3
        with:
          path: dist

      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
      - name: Setup pnpm
        uses: pnpm/action-setup@v4.1.0
        with:
          version: 10

      - run: pnpm install && pnpm format && pnpm build
      - name: Commit changes
        uses: EndBug/add-and-commit@v9.1.3
        with:
          default_author: github_actions
          message: '[bot] bundle'

      # è‡ªåŠ¨æ‰“ç‰ˆæœ¬ tag, ä»è€Œè®© jsdelivr åŸºäºç‰ˆæœ¬å·åœ¨ 12h å†…æ›´æ–°ç¼“å­˜è€Œä¸æ˜¯ç”¨éç‰ˆæœ¬å·çš„ 7d ç¼“å­˜
      - id: autotag
        uses: phish108/autotag-action@v1.1.64
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          with-v: true
      - if: ${{ steps.autotag.outputs.tag != '0.0.0' }}
        run: git push --delete origin ${{ steps.autotag.outputs.tag }}

      # è¯»å–ç‰ˆæœ¬å·
      - name: Read version
        id: read_version
        run: |
          VERSION=$(grep -oP "export const FRONTEND_VERSION = '([^']+)'" src/å“¥å¸ƒæ—å·¢ç©´-ç®€ç‰ˆ/version.ts | grep -oP "'([^']+)'" | tr -d "'")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "è¯»å–åˆ°ç‰ˆæœ¬å·: $VERSION"

      # ä¸Šä¼ å¸¦ç‰ˆæœ¬å·çš„ index.html åˆ° Cloudflare R2
      - name: Upload versioned index.html to Cloudflare R2
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
          R2_BUCKET: gobgame-pic
          R2_ACCOUNT_ID: ${{ secrets.R2_ACCOUNT_ID }}
          VERSION: ${{ steps.read_version.outputs.version }}
        run: |
          # æ£€æŸ¥å¸¦ç‰ˆæœ¬å·çš„æ–‡ä»¶æ˜¯å¦å­˜åœ¨
          VERSIONED_FILE="dist/å“¥å¸ƒæ—å·¢ç©´-ç®€ç‰ˆ/index-v${VERSION}.html"
          if [ ! -f "$VERSIONED_FILE" ]; then
            echo "é”™è¯¯: ç‰ˆæœ¬åŒ–æ–‡ä»¶ä¸å­˜åœ¨: $VERSIONED_FILE"
            echo "æ„å»ºè¾“å‡ºç›®å½•å†…å®¹:"
            ls -la dist/ || echo "dist ç›®å½•ä¸å­˜åœ¨"
            ls -la dist/å“¥å¸ƒæ—å·¢ç©´-ç®€ç‰ˆ/ || echo "dist/å“¥å¸ƒæ—å·¢ç©´-ç®€ç‰ˆ/ ç›®å½•ä¸å­˜åœ¨"
            exit 1
          fi

          # ä¸Šä¼ å¸¦ç‰ˆæœ¬å·çš„æ–‡ä»¶
          echo "ä¸Šä¼ ç‰ˆæœ¬åŒ–æ–‡ä»¶: index-v${VERSION}.html"
          aws s3 cp "$VERSIONED_FILE" "s3://${R2_BUCKET}/index-v${VERSION}.html" \
            --endpoint-url "https://${R2_ACCOUNT_ID}.r2.cloudflarestorage.com" \
            --content-type "text/html" \
            --cache-control "no-cache, must-revalidate"

          echo "âœ“ å·²ä¸Šä¼ ç‰ˆæœ¬ ${VERSION} åˆ° R2 å­˜å‚¨"

      # ğŸ”¹ ç”Ÿæˆå¹¶ä¸Šä¼ ç‰ˆæœ¬åˆ—è¡¨æ–‡ä»¶
      - name: Update version list and upload to R2
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
          R2_BUCKET: gobgame-pic
          R2_ACCOUNT_ID: ${{ secrets.R2_ACCOUNT_ID }}
          VERSION: ${{ steps.read_version.outputs.version }}
        run: |
          # è¯»å–ç‰ˆæœ¬å·ã€æ—¥æœŸå’Œæè¿°
          VERSION_DATE=$(grep -oP "export const FRONTEND_UPDATE_DATE = '([^']+)'" src/å“¥å¸ƒæ—å·¢ç©´-ç®€ç‰ˆ/version.ts | grep -oP "'([^']+)'" | tr -d "'")
          VERSION_DESC=$(grep -oP "export const FRONTEND_DESCRIPTION = '([^']+)'" src/å“¥å¸ƒæ—å·¢ç©´-ç®€ç‰ˆ/version.ts | grep -oP "'([^']+)'" | tr -d "'")

          # å¦‚æœæè¿°ä¸ºç©ºï¼Œä½¿ç”¨é»˜è®¤å€¼
          if [ -z "$VERSION_DESC" ]; then
            VERSION_DESC="æœ€æ–°ç‰ˆæœ¬"
          fi

          # å¦‚æœç‰ˆæœ¬åˆ—è¡¨æ–‡ä»¶å·²å­˜åœ¨ï¼Œè¯»å–å¹¶æ›´æ–°ï¼›å¦åˆ™åˆ›å»ºæ–°çš„
          if aws s3 ls "s3://${R2_BUCKET}/versions.json" --endpoint-url "https://${R2_ACCOUNT_ID}.r2.cloudflarestorage.com" > /dev/null 2>&1; then
            echo "ç‰ˆæœ¬åˆ—è¡¨æ–‡ä»¶å·²å­˜åœ¨ï¼Œè¯»å–å¹¶æ›´æ–°..."
            aws s3 cp "s3://${R2_BUCKET}/versions.json" versions.json \
              --endpoint-url "https://${R2_ACCOUNT_ID}.r2.cloudflarestorage.com"
            
            # æ£€æŸ¥ç‰ˆæœ¬æ˜¯å¦å·²å­˜åœ¨
            if grep -q "\"version\": \"${VERSION}\"" versions.json; then
              echo "ç‰ˆæœ¬ ${VERSION} å·²å­˜åœ¨äºç‰ˆæœ¬åˆ—è¡¨ä¸­ï¼Œè·³è¿‡æ·»åŠ "
            else
              # ä½¿ç”¨ Python æ›´æ–° JSONï¼ˆæ›´å¯é ï¼‰
              python3 << EOF
          import json

          with open('versions.json', 'r', encoding='utf-8') as f:
              data = json.load(f)

          new_version = {
              "version": "${VERSION}",
              "description": "${VERSION_DESC}",
              "date": "${VERSION_DATE}"
          }

          # ç§»é™¤å·²å­˜åœ¨çš„ç›¸åŒç‰ˆæœ¬
          data["versions"] = [v for v in data["versions"] if v["version"] != "${VERSION}"]

          # æ·»åŠ åˆ°åˆ—è¡¨å¼€å¤´ï¼ˆæœ€æ–°ç‰ˆæœ¬åœ¨å‰ï¼‰
          data["versions"].insert(0, new_version)

          # ä¿å­˜æ–‡ä»¶
          with open('versions.json', 'w', encoding='utf-8') as f:
              json.dump(data, f, indent=2, ensure_ascii=False)
          EOF
              echo "âœ“ å·²æ·»åŠ ç‰ˆæœ¬ ${VERSION} åˆ°ç‰ˆæœ¬åˆ—è¡¨"
            fi
          else
            echo "ç‰ˆæœ¬åˆ—è¡¨æ–‡ä»¶ä¸å­˜åœ¨ï¼Œåˆ›å»ºæ–°æ–‡ä»¶..."
            cat > versions.json << EOF
          {
            "versions": [
              {
                "version": "${VERSION}",
                "description": "${VERSION_DESC}",
                "date": "${VERSION_DATE}"
              }
            ]
          }
          EOF
          fi

          # ä¸Šä¼ ç‰ˆæœ¬åˆ—è¡¨æ–‡ä»¶
          echo "ä¸Šä¼ ç‰ˆæœ¬åˆ—è¡¨æ–‡ä»¶..."
          aws s3 cp versions.json "s3://${R2_BUCKET}/versions.json" \
            --endpoint-url "https://${R2_ACCOUNT_ID}.r2.cloudflarestorage.com" \
            --content-type "application/json" \
            --cache-control "public, max-age=300"

          echo "âœ“ ç‰ˆæœ¬åˆ—è¡¨å·²æ›´æ–°å¹¶ä¸Šä¼ åˆ° R2 å­˜å‚¨"

      # ğŸ”¹ æ¸…ç† Cloudflare Edge ç¼“å­˜
      - name: Purge Cloudflare Cache
        env:
          CF_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CF_ZONE_ID: ${{ secrets.CF_ZONE_ID }}
          VERSION: ${{ steps.read_version.outputs.version }}
        run: |
          curl -X POST "https://api.cloudflare.com/client/v4/zones/${CF_ZONE_ID}/purge_cache" \
            -H "Authorization: Bearer ${CF_API_TOKEN}" \
            -H "Content-Type: application/json" \
            --data '{"files":["https://kitakamis.online/index-v'${VERSION}'.html"]}'
