# 消息交互功能模块

这个模块提供了可复用的消息交互功能，可以在任何界面中使用。

## 文件结构

- `消息类型.ts` - 消息相关的类型定义
- `消息服务.ts` - 消息服务类，提供核心功能
- `消息聊天.ts` - Vue Composable，提供响应式状态和方法

## 使用方法

### 1. 在 Vue 组件中使用

```vue
<template>
  <div>
    <!-- 消息列表 -->
    <div ref="messageContainer" class="messages">
      <div v-for="message in messages" :key="message.message_id" class="message">
        <div class="message-header">
          <span class="sender">{{ message.sender }}</span>
          <span class="time">{{ message.time }}</span>
        </div>
        <div class="message-body" v-html="formatMessage(message.content)"></div>
      </div>
    </div>

    <!-- 输入区域 -->
    <div class="input-area">
      <textarea v-model="currentMessage" @keydown.enter.prevent="sendMessage"></textarea>
      <button @click="sendMessage">发送</button>
    </div>

    <!-- 控制按钮 -->
    <div class="controls">
      <button @click="clearMessages">清空</button>
      <button @click="exportMessages">导出</button>
    </div>
  </div>
</template>

<script setup lang="ts">
import { useMessageChat } from './消息模块/消息聊天';

// 使用消息聊天功能
const {
  messages,
  currentMessage,
  isLoading,
  containerRef: messageContainer,
  sendMessage,
  clearMessages,
  formatMessage,
  exportMessages,
} = useMessageChat();
</script>
```

### 2. 直接使用 MessageService

```typescript
import { MessageService } from './消息模块/消息服务';

// 发送消息
const aiResponse = await MessageService.sendMessage({
  userInput: '你好',
  onSuccess: (response) => console.log('成功:', response),
  onError: (error) => console.error('错误:', error)
});

// 格式化消息
const formatted = MessageService.formatMessage('**粗体** 和 `代码`');

// 导出消息
MessageService.exportMessages(messages, { format: 'json', filename: 'chat_log' });
```

### 3. 高级用法

```typescript
import { useMessageChat } from './消息模块/消息聊天';

const {
  messages,
  addSystemMessage,
  addUserMessage,
  addAIMessage,
} = useMessageChat();

// 添加系统消息
addSystemMessage('系统提示：游戏开始');

// 添加用户消息（不发送到AI）
addUserMessage('玩家说：我选择攻击');

// 添加AI消息
addAIMessage('AI回复：你成功击败了敌人！');
```

## 功能特性

- ✅ 消息发送和接收
- ✅ AI 对话生成
- ✅ **流式输出支持** (Streaming Output)
- ✅ 消息格式化（Markdown 支持）
- ✅ 历史消息加载
- ✅ 消息导出（TXT/JSON）
- ✅ 自动滚动
- ✅ 错误处理
- ✅ 响应式状态管理
- ✅ TypeScript 支持
- ✅ 英文双引号支持（""）
- ✅ 中文双引号支持（""）
- ✅ 中文双引号支持（「」）
- ✅ 中文双引号支持（『』）
- ✅ 英文单引号支持（''）

## 自定义选项

### 消息格式化选项

```typescript
const formatted = formatMessage(content, {
  enableMarkdown: true,
  enableCodeHighlight: true,
  enableQuote: true
});
```

### 导出选项

```typescript
exportMessages(messages, {
  format: 'json', // 'txt' | 'json'
  filename: 'my_chat'
});
```

### 发送选项

```typescript
sendMessage({
  onSuccess: (response) => {
    console.log('AI回复:', response);
  },
  onError: (error) => {
    console.error('发送失败:', error);
  }
});
```

### 流式输出选项

```typescript
// 启用流式传输
sendMessage({
  userInput: '你好',
  enableStream: true, // 启用流式传输
  onStreamUpdate: (streamingText) => {
    // 实时更新界面显示流式文本
    console.log('流式更新:', streamingText);
    // 可以立即更新UI，无需等待完整回复
    updateDisplay(streamingText);
  },
  onSuccess: (finalText) => {
    console.log('完整回复:', finalText);
  },
  onError: (error) => {
    console.error('发送失败:', error);
  }
});
```

**流式输出说明：**
- `enableStream: true` - 启用流式传输
- `onStreamUpdate` - 每次收到新的文本片段时触发，可以实时更新界面
- 流式传输会逐字显示AI回复，提升用户体验
- 流式传输会自动应用酒馆正则处理
